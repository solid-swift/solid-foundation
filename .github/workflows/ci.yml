name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-macos:
    name: Test (macOS)
    runs-on: macos-26
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2.3"

      - name: Install zstd
        run: brew install zstd

      - name: Cache Homebrew packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/Cellar/jemalloc
          key: homebrew-${{ runner.os }}-jemalloc-v1

      - name: Install JEMalloc
        run: brew install jemalloc

      - name: Restore SPM cache
        id: cache-spm
        uses: actions/cache/restore@v4
        with:
          path: .build
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            spm-${{ runner.os }}-

      - name: Build
        run: >
          swift build
          --enable-code-coverage
          --sanitize thread
          --sanitize undefined

      - name: Save SPM cache
        if: steps.cache-spm.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: .build
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}

      - name: Test
        run: >
          swift test
          --enable-code-coverage
          --sanitize thread
          --sanitize undefined
          --xunit-output .build/test-results.xml

      - name: Generate Reports
        if: always()
        run: |
          # Find the coverage JSON generated by swift test
          COVERAGE_JSON=$(swift test --show-code-coverage-path)
          COVERAGE_ARG=""
          if [ -n "$COVERAGE_JSON" ] && [ -f "$COVERAGE_JSON" ]; then
            COVERAGE_ARG="--coverage-path $COVERAGE_JSON"
          fi
          swift run test-report \
          --all --mergeable \
          --output test-reports-macos \
          --xunit-path .build/test-results-swift-testing.xml \
          $COVERAGE_ARG

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-macos
          path: test-reports-macos
          retention-days: 30

  test-linux:
    name: Test (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2.3"
          skip-verify-signature: true

      - name: Install zstd
        run: sudo apt-get install -y zstd

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: apt-${{ runner.os }}-jemalloc-v1

      - name: Install JEMalloc
        run: |
          sudo apt-get update
          sudo apt-get install -y libjemalloc2

      - name: Restore SPM cache
        id: cache-spm
        uses: actions/cache/restore@v4
        with:
          path: .build
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            spm-${{ runner.os }}-

      - name: Build
        run: >
          swift build
          --sanitize thread

      - name: Save SPM cache
        if: steps.cache-spm.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: .build
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}

      - name: Test
        run: >
          swift test
          --xunit-output .build/test-results.xml

      - name: Generate Reports
        if: always()
        run: |
          swift run test-report \
          --all --mergeable \
          --output test-reports-linux \
          --xunit-path .build/test-results-swift-testing.xml

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-linux
          path: test-reports-linux
          retention-days: 30

  validate-readme:
    name: Validate README
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2.3"
          skip-verify-signature: true

      - name: Install zstd
        run: sudo apt-get install -y zstd

      - name: Restore SPM cache
        id: cache-spm
        uses: actions/cache/restore@v4
        with:
          path: .build
          key: spm-readme-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            spm-readme-${{ runner.os }}-

      - name: Build Snippets
        run: swift build --target Snippets

      - name: Save SPM cache
        if: steps.cache-spm.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: .build
          key: spm-readme-${{ runner.os }}-${{ hashFiles('Package.resolved') }}

      - name: Validate README is up to date
        run: swift run readme-build --check

  pr-reports:
    name: PR Reports
    runs-on: ubuntu-latest
    needs: [test-macos, test-linux, validate-readme]
    if: github.event_name == 'pull_request' && always()
    permissions:
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2.3"
          skip-verify-signature: true

      - name: Download macOS Reports
        uses: actions/download-artifact@v4
        with:
          name: test-reports-macos
          path: test-reports-macos
        continue-on-error: true

      - name: Download Linux Reports
        uses: actions/download-artifact@v4
        with:
          name: test-reports-linux
          path: test-reports-linux
        continue-on-error: true

      - name: Merge Reports
        run: |
          REPORT_DIRS=""
          if [ -d "test-reports-macos" ]; then
            REPORT_DIRS="$REPORT_DIRS test-reports-macos"
          fi
          if [ -d "test-reports-linux" ]; then
            REPORT_DIRS="$REPORT_DIRS test-reports-linux"
          fi
          if [ -n "$REPORT_DIRS" ]; then
            swift run test-report merge --output merged-reports $REPORT_DIRS
            cat merged-reports/actions-summary.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Post PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('merged-reports/pr-comment.md')) {
              console.log('No PR comment file found, skipping');
              return;
            }
            
            const comment = fs.readFileSync('merged-reports/pr-comment.md', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('## Test Results')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
