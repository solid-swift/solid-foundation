name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-macos:
    name: Test (macOS)
    runs-on: macos-26
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2.3"

      - name: Install JEMalloc
        run: brew install jemalloc

      - name: Build
        run: >
          swift build
          --enable-code-coverage
          --sanitize thread
          --sanitize undefined

      - name: Test
        run: >
          swift test
          --enable-code-coverage
          --sanitize thread
          --sanitize undefined
          --xunit-output .build/test-results.xml

      - name: Generate Reports
        if: always()
        run: |
          # Find the coverage JSON generated by swift test
          COVERAGE_JSON=$(swift test --show-code-coverage-path)
          COVERAGE_ARG=""
          if [ -n "$COVERAGE_JSON" ] && [ -f "$COVERAGE_JSON" ]; then
            COVERAGE_ARG="--coverage-path $COVERAGE_JSON"
          fi
          swift run test-report \
          --all --mergeable \
          --output test-reports-macos \
          --xunit-path .build/test-results-swift-testing.xml \
          $COVERAGE_ARG

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-macos
          path: test-reports-macos
          retention-days: 30

  test-linux:
    name: Test (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2.3"
          skip-verify-signature: true

      - name: Install JEMalloc
        run: |
          sudo apt update
          sudo apt install libjemalloc2 

      - name: Build
        run: >
          swift build
          --sanitize thread

      - name: Test
        run: >
          swift test
          --xunit-output .build/test-results.xml

      - name: Generate Reports
        if: always()
        run: |
          swift run test-report \
          --all --mergeable \
          --output test-reports-linux \
          --xunit-path .build/test-results-swift-testing.xml

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-linux
          path: test-reports-linux
          retention-days: 30

  pr-reports:
    name: PR Reports
    runs-on: ubuntu-latest
    needs: [test-macos, test-linux]
    if: github.event_name == 'pull_request' && always()
    permissions:
      pull-requests: write
    steps:
      - name: Download macOS Reports
        uses: actions/download-artifact@v4
        with:
          name: test-reports-macos
          path: test-reports-macos
        continue-on-error: true

      - name: Download Linux Reports
        uses: actions/download-artifact@v4
        with:
          name: test-reports-linux
          path: test-reports-linux
        continue-on-error: true

      - name: Generate Test Results
        id: generate-comment
        run: |
          COMMENT=""
          
          # Add test results summary
          COMMENT+="## Test Results Summary\n\n"
          
          # macOS results
          if [ -f "test-reports-macos/test-summary.md" ]; then
            COMMENT+="### macOS\n\n"
            COMMENT+="$(cat test-reports-macos/test-summary.md | tail -n +3)\n\n"
          fi
          
          # Linux results
          if [ -f "test-reports-linux/test-summary.md" ]; then
            COMMENT+="### Linux\n\n"
            COMMENT+="$(cat test-reports-linux/test-summary.md | tail -n +3)\n\n"
          fi
          
          # Add coverage overview (macOS only)
          if [ -f "test-reports-macos/coverage-summary.md" ]; then
            COMMENT+="\n---\n\n"
            COMMENT+="### Coverage\n\n"
            COMMENT+="$(cat test-reports-macos/coverage-summary.md)\n\n"
          fi

          # Write comment to file
          echo -e "$COMMENT" > pr-comment.md
          
          # Add test result details to summary
          
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          
          # macOS results
          if [ -f "test-reports-macos/test-detail.md" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### macOS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$(cat test-reports-macos/test-detail.md)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Linux results
          if [ -f "test-reports-linux/test-detail.md" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Linux" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$(cat test-reports-linux/test-detail.md)\n\n" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Add coverage (macOS only)
          if [ -f "test-reports-macos/coverage-detail.md" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Coverage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$(cat test-reports-macos/coverage-detail.md)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Post PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('pr-comment.md', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('## Test Results Summary')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
